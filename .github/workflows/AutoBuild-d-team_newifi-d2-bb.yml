###########################################################
#  OpenWrt Auto-Compiler for Newifi D2
#  Author: Hyy2001X
#  Features:
#  - å¤šé…ç½®æ”¯æŒ (æ ‡å‡†ç‰ˆ/ç²¾ç®€ç‰ˆ/Clashé›†æˆç‰ˆ)
#  - å®šæ—¶/æ‰‹åŠ¨/Starè§¦å‘ç¼–è¯‘
#  - æ™ºèƒ½ç£ç›˜ç©ºé—´ä¼˜åŒ–
#  - å¤šå¹³å°å›ºä»¶ä¸Šä¼  (Releases/Artifacts)
#  - è‡ªåŠ¨åŒ–ä¾èµ–ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶
#  Reference: https://github.com/P3TERX/Actions-OpenWrt
###########################################################

name: ğŸ› ï¸ NEWIFI-D2 OpenWrt Builder

on:
  # ä»“åº“äº‹ä»¶è§¦å‘ (é€šè¿‡GitHubç•Œé¢æ‰‹åŠ¨è§¦å‘)
  workflow_dispatch:
    inputs:
      Tempoary_CONFIG:
        description: 'é€‰æ‹©è®¾å¤‡é…ç½®æ–‡ä»¶'
        default: 'd-team_newifi-d2'
        type: choice
        options:
          - 'd-team_newifi-d2'       # æ ‡å‡†é…ç½®
          - 'd-team_newifi-d2-Clash' # Clashé›†æˆç‰ˆ
          - 'd-team_newifi-d2-Lite'  # ç²¾ç®€ç‰ˆ
          - 'd-team_newifi-d2-bb'    # å¤‡ç”¨é…ç½®
      
      Tempoary_FLAG:
        description: 'å›ºä»¶ç±»å‹æ ‡ç­¾'
        default: 'AUTO'
        type: choice
        options:
          - 'AUTO'  # è‡ªåŠ¨è¯†åˆ«
          - 'Full'  # å…¨åŠŸèƒ½ç‰ˆ
          - 'Clash' # Clashä¸“ç‰ˆ
          - 'Lite'  # ç²¾ç®€ç‰ˆ
          - 'bb'    # å¤‡ç”¨ç‰ˆ

      Tempoary_IP:
        description: 'è‡ªå®šä¹‰å›ºä»¶IPåœ°å€ (å¯é€‰)'
        default: ''

      # å‘å¸ƒæ§åˆ¶å‚æ•°
      UPLOAD_RELEASES:
        description: 'ä¸Šä¼ åˆ°Releases'
        default: 'true'
        type: boolean
      UPLOAD_ARTIFACTS:
        description: 'ä¸Šä¼ åˆ°Artifacts'
        default: 'false'
        type: boolean
      UPLOAD_BIN_ARTIFACTS:
        description: 'ä¸Šä¼ binç›®å½•'
        default: 'false'
        type: boolean

  # å®šæ—¶è§¦å‘ (æ¯å‘¨äº”8ç‚¹UTC)
  schedule:
    - cron: '0 8 * * 5'

  # Pushè§¦å‘ (æ¨é€åˆ°masteråˆ†æ”¯æ—¶)
  push:
    branches:
      - master

  # Starè§¦å‘ (å½“ç”¨æˆ·Starä»“åº“æ—¶)
  watch:
    types: [started]

env:
  # æ ¸å¿ƒé…ç½®å‚æ•°
  CONFIG_FILE: d-team_newifi-d2          # é»˜è®¤é…ç½®æ–‡ä»¶
  DEFAULT_SOURCE: coolsnowwolf/lede:master # æºç ä»“åº“: coolsnowwolf/ledeçš„masteråˆ†æ”¯
  DELETE_USELESS_FILES: true             # å¯ç”¨ç£ç›˜æ¸…ç†
  DELETE_OLD_WORKFLOW: true              # è‡ªåŠ¨æ¸…ç†7å¤©å‰çš„workflow
  CACHE_ACCELERATE: true                 # å¯ç”¨ç¼–è¯‘ç¼“å­˜åŠ é€Ÿ

jobs:
  Compile:
    name: ğŸ› ï¸ Build OpenWrt
    runs-on: ubuntu-20.04
    timeout-minutes: 120  # è¶…æ—¶è®¾ç½®ä¸º2å°æ—¶
    permissions:
      actions: write
      checks: write
      contents: write
      deployments: write
      issues: write
      packages: write
      pull-requests: write
      repository-projects: write
      security-events: write
      statuses: write

    steps:
    # é˜¶æ®µ1: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
    - name: ğŸ”§ åˆå§‹åŒ–å·¥ä½œç©ºé—´
      uses: actions/checkout@v4  # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ
      with:
        fetch-depth: 0           # è·å–å®Œæ•´æäº¤å†å²

    - name: ğŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´
      if: env.DELETE_USELESS_FILES == 'true'
      uses: luchihoratiu/cleanup-disk-space@v1
      with:
        # ä¿ç•™å…³é”®ç¼–è¯‘å·¥å…·é“¾
        preserve-toolchain: true
        # æ¸…ç†ç³»ç»Ÿæ— ç”¨æ–‡ä»¶
        clean-system: true
        # ä¿ç•™è‡³å°‘10GBç©ºé—´
        min-free-space: 10240

    # é˜¶æ®µ2: é…ç½®æ„å»ºå‚æ•°
    - name: âš™ï¸ åŠ è½½æ„å»ºå‚æ•°
      id: config
      run: |
        # é…ç½®æ–‡ä»¶é€‰æ‹©é€»è¾‘
        if [ -n "${{ inputs.Tempoary_CONFIG }}" ]; then
          CONFIG_FILE="${{ inputs.Tempoary_CONFIG }}"
        else
          CONFIG_FILE="${{ env.CONFIG_FILE }}"
        fi

        # éªŒè¯é…ç½®æ–‡ä»¶å­˜åœ¨
        if [ ! -f "Configs/${CONFIG_FILE}" ]; then
          echo "âŒ é…ç½®æ–‡ä»¶ [${CONFIG_FILE}] ä¸å­˜åœ¨!" >&2
          exit 1
        fi

        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV
        echo "BUILD_TIMESTAMP=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date '+%Y-%m-%d %H:%M')" >> $GITHUB_ENV

    # é˜¶æ®µ3: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
    - name: ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        # åŸºç¡€ç¼–è¯‘å·¥å…·é“¾
        sudo apt-get install -y build-essential ccache flex git-core g++-multilib \\
          gcc-multilib gettext libncurses5-dev libssl-dev python3-distutils \\
          uglifyjs unzip zlib1g-dev file wget
        # é«˜çº§åŠŸèƒ½æ”¯æŒ
        sudo apt-get install -y qemu-utils upx libelf-dev automake autoconf \\
          device-tree-compiler antlr3 gperf haveged lrzsz

    # é˜¶æ®µ4: è·å–æºç 
    - name: ğŸ“¥ å…‹éš†OpenWrtæºç 
      id: clone
      run: |
        repo_url="https://github.com/${env.DEFAULT_SOURCE%%:*}"
        branch="${env.DEFAULT_SOURCE#*:}"
        
        echo "ğŸ”„ æ­£åœ¨å…‹éš†ä»“åº“: ${repo_url} (åˆ†æ”¯: ${branch})"
        git clone --depth 1 --branch "${branch}" "${repo_url}" openwrt
        
        # é…ç½®ccacheç¼“å­˜
        echo "CCACHE_DIR=$GITHUB_WORKSPACE/.ccache" >> $GITHUB_ENV
        mkdir -p "$CCACHE_DIR"
        echo "max_size = 2.0G" > "$CCACHE_DIR/ccache.conf"

    # é˜¶æ®µ5: é…ç½®æ„å»ºç³»ç»Ÿ
    - name: âš™ï¸ åº”ç”¨è®¾å¤‡é…ç½®
      run: |
        cd openwrt
        # åº”ç”¨åŸºç¡€é…ç½®
        cp "../Configs/$CONFIG_FILE" .config
        make defconfig
        
        # è‡ªå®šä¹‰é…ç½®æ³¨å…¥
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_BUILDBOT=y" >> .config
        echo "CONFIG_DEVEL=y" >> .config

    # é˜¶æ®µ6: ä¾èµ–ç®¡ç†
    - name: ğŸ“¦ ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make download -j$(nproc)  # å¹¶è¡Œä¸‹è½½ä¾èµ–

    # é˜¶æ®µ7: ç¼–è¯‘è¿‡ç¨‹
    - name: ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        # ä½¿ç”¨ccacheåŠ é€Ÿç¼–è¯‘
        export PATH="/usr/lib/ccache:$PATH"
        
        # å¹¶è¡Œç¼–è¯‘ï¼ˆæ ¹æ®CPUæ ¸å¿ƒæ•°è‡ªåŠ¨è°ƒæ•´ï¼‰
        make -j$(($(nproc) + 1)) || make -j1 V=s
        
        # ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        echo "ç¼–è¯‘çŠ¶æ€: $?"
        [ $? -eq 0 ] && echo "COMPILE_STATUS=success" >> $GITHUB_ENV || echo "COMPILE_STATUS=failed" >> $GITHUB_ENV

    # é˜¶æ®µ8: äº§ç‰©å¤„ç†
    - name: ğŸš€ å‘å¸ƒå›ºä»¶
      if: env.COMPILE_STATUS == 'success'
      env:
        UPLOAD_URL: ${{ github.server_url }}/repos/${{ github.repository }}/releases
      run: |
        # ç”Ÿæˆå›ºä»¶å…ƒæ•°æ®
        FIRMWARE_DIR="openwrt/bin/targets/ramips/mt7621"
        echo "å›ºä»¶ç‰ˆæœ¬: $(cat ${FIRMWARE_DIR}/version.txt)"
        echo "ç¼–è¯‘æ—¶é—´: ${{ env.BUILD_DATE }}"
        
        # è‡ªåŠ¨é‡å‘½åå›ºä»¶æ–‡ä»¶
        for f in ${FIRMWARE_DIR}/*.bin; do
          new_name="NewifiD2_${CONFIG_FILE}_${BUILD_TIMESTAMP}.bin"
          mv "$f" "${FIRMWARE_DIR}/${new_name}"
        done

    # é˜¶æ®µ9: äº§ç‰©ä¸Šä¼ 
    - name: ğŸ“¤ ä¸Šä¼ åˆ°Releases
      if: inputs.UPLOAD_RELEASES == 'true'
      uses: softprops/action-gh-release@v1
      with:
        files: openwrt/bin/targets/ramips/mt7621/*.bin
        tag_name: AutoBuild-${{ env.BUILD_TIMESTAMP }}
        body: |
          ğŸš€ è‡ªåŠ¨ç¼–è¯‘å›ºä»¶
          - è®¾å¤‡: Newifi D2
          - é…ç½®: ${{ env.CONFIG_FILE }}
          - ç¼–è¯‘æ—¶é—´: ${{ env.BUILD_DATE }}

    - name: ğŸ“¦ ä¸Šä¼ åˆ°Artifacts
      if: inputs.UPLOAD_ARTIFACTS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-Binaries
        path: |
          openwrt/bin/targets/**
          !openwrt/bin/targets/*/packages

    # é˜¶æ®µ10: åå¤„ç†
    - name: ğŸ§¹ æ¸…ç†å†å²Workflows
      if: env.DELETE_OLD_WORKFLOW == 'true'
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        retain_days: 7
        keep_minimum_runs: 3

    # é”™è¯¯å¤„ç†
    - name: ğŸš¨ ç¼–è¯‘å¤±è´¥é€šçŸ¥
      if: env.COMPILE_STATUS == 'failed'
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥! è¯·æ£€æŸ¥æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          })
