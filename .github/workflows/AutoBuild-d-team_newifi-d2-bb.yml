###########################################################
#  OpenWrt è‡ªåŠ¨ç¼–è¯‘å·¥ä½œæµ - Newifi D2 ä¸“ç”¨ç‰ˆ
#  åŠŸèƒ½ç‰¹æ€§ï¼š
#  - æ”¯æŒå¤šé…ç½®ç¼–è¯‘ï¼ˆæ ‡å‡†ç‰ˆ/ç²¾ç®€ç‰ˆ/Clashé›†æˆç‰ˆï¼‰
#  - æ™ºèƒ½ç£ç›˜ç©ºé—´ç®¡ç†
#  - ç¼–è¯‘ç¼“å­˜åŠ é€Ÿ
#  - è‡ªåŠ¨åŒ–å›ºä»¶å‘å¸ƒï¼ˆReleases/Artifactsï¼‰
#  - å¤±è´¥é€šçŸ¥æœºåˆ¶
###########################################################

name: ğŸš€ OpenWrt Builder - Newifi D2

on:
  # è§¦å‘æ–¹å¼é…ç½®
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘
    inputs: {...}       # ä¿ç•™åŸæœ‰è¾“å…¥å‚æ•°
  
  schedule:             # æ¯å‘¨äº” UTC 8:00 è‡ªåŠ¨ç¼–è¯‘
    - cron: '0 8 * * 5'
  
  push:                 # æ¨é€è‡³ master åˆ†æ”¯è§¦å‘
    branches: [master]
  
  watch:                # Star ä»“åº“è§¦å‘
    types: [started]

env:
  # å…¨å±€é…ç½®å‚æ•°
  CONFIG_FILE: d-team_newifi-d2        # é»˜è®¤é…ç½®æ–‡ä»¶
  DEFAULT_SOURCE: coolsnowwolf/lede@master  # æºç ä»“åº“
  CCACHE_DIR: /github/workspace/.ccache     # ç¼“å­˜ç›®å½•
  DELETE_OLD_WORKFLOW_DAYS: 7              # æ—¥å¿—ä¿ç•™å¤©æ•°

jobs:
  Compile:
    name: ğŸ› ï¸ å›ºä»¶ç¼–è¯‘
    runs-on: ubuntu-20.04
    timeout-minutes: 120  # è¶…æ—¶è®¾ç½®

    steps:
    # é˜¶æ®µ 1: åˆå§‹åŒ–ç¯å¢ƒ
    - name: ğŸ—ï¸ å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

    # é˜¶æ®µ 2: ç£ç›˜ç©ºé—´ä¼˜åŒ–
    - name: ğŸ§¹ æ·±åº¦æ¸…ç†ç£ç›˜
      uses: ScribeMD/cleanup-disk-space@v2.2.1
      with:
        cleanup: true
        verbose: true
        folders: |
          /usr/local/lib/android
          /opt/ghc
          /usr/local/lib/node_modules
        reserve-mb: 5120  # ä¿ç•™æœ€å°ç©ºé—´

    # é˜¶æ®µ 3: å®‰è£…ç¼–è¯‘ä¾èµ–
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache flex bison git g++-multilib \
          gcc-multilib gettext libncurses5-dev libssl-dev \
          python3-distutils rsync unzip zlib1g-dev file wget \
          qemu-utils upx libelf-dev automake autoconf

    # é˜¶æ®µ 4: æºç ç®¡ç†
    - name: ğŸ“¥ å…‹éš† OpenWrt æºç 
      run: |
        git clone --depth 1 \
          -b master \
          https://github.com/${{ env.DEFAULT_SOURCE }} \
          openwrt

    # é˜¶æ®µ 5: ç¼“å­˜é…ç½®
    - name: âš¡ å¯ç”¨ç¼–è¯‘ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.CCACHE_DIR }}
          openwrt/dl
        key: ${{ runner.os }}-openwrt-${{ hashFiles('Configs/*') }}

    # é˜¶æ®µ 6: åº”ç”¨è®¾å¤‡é…ç½®
    - name: âš™ï¸ åŠ è½½è®¾å¤‡é…ç½®
      run: |
        cd openwrt
        cp ../Configs/${{ env.CONFIG_FILE }} .config
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig

    # é˜¶æ®µ 7: ç¼–è¯‘è¿‡ç¨‹
    - name: ğŸ”¨ æ‰§è¡Œç¼–è¯‘ä»»åŠ¡
      run: |
        cd openwrt
        export PATH="/usr/lib/ccache:$PATH"
        make -j$(($(nproc) + 1)) \
          || make -j1 V=s  # é™çº§æ¨¡å¼

    # é˜¶æ®µ 8: äº§ç‰©å¤„ç†
    - name: ğŸ“¦ æ‰“åŒ…å›ºä»¶æ–‡ä»¶
      if: success()
      run: |
        cd openwrt/bin/targets/ramips/mt7621
        FIRMWARE_NAME="NewifiD2_${CONFIG_FILE}_$(date +%Y%m%d).bin"
        mv *-sysupgrade.bin $FIRMWARE_NAME
        echo "FIRMWARE=$FIRMWARE_NAME" >> $GITHUB_ENV

    # é˜¶æ®µ 9: å‘å¸ƒç®¡ç†
    - name: ğŸš€ å‘å¸ƒåˆ° GitHub Releases
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: autobuild-${{ github.run_id }}
        files: openwrt/bin/targets/ramips/mt7621/${{ env.FIRMWARE }}
        body: |
          ### ğŸš€ è‡ªåŠ¨ç¼–è¯‘å›ºä»¶
          - è®¾å¤‡å‹å·: Newifi D2  
          - ç¼–è¯‘æ—¶é—´: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - æºç ç‰ˆæœ¬: ${{ env.DEFAULT_SOURCE }}

    # é˜¶æ®µ 10: å¤±è´¥å¤„ç†
    - name: ğŸš¨ ç¼–è¯‘å¤±è´¥é€šçŸ¥
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: 'âŒ ç¼–è¯‘å¤±è´¥! æŸ¥çœ‹æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          })

    # é˜¶æ®µ 11: æ—¥å¿—æ¸…ç†
    - name: ğŸ—‘ï¸ æ¸…ç†å†å²æ—¥å¿—
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: ${{ env.DELETE_OLD_WORKFLOW_DAYS }}
        keep_minimum_runs: 5
